generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 사용자 및 인증 ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  name          String
  nickname      String?   @unique
  profileImage  String?
  phoneNumber   String?
  phoneVerified Boolean   @default(false)
  role          UserRole  @default(USER)
  status        UserStatus @default(ACTIVE)

  isExpert      Boolean   @default(false)
  expertProfile ExpertProfile?

  accounts      Account[]
  sessions      Session[]
  portfolios    Portfolio[]
  posts         Post[]
  comments      Comment[]
  reviews       Review[]
  receivedReviews Review[] @relation("ReviewTarget")
  sentMessages  DirectMessage[] @relation("MessageSender")
  receivedMessages DirectMessage[] @relation("MessageReceiver")
  chatRoomMembers ChatRoomMember[]
  mentoringSessions MentoringSession[] @relation("Mentor")
  menteeSessions MentoringSession[] @relation("Mentee")
  transactions  Transaction[]
  notifications Notification[]
  bookmarks     Bookmark[]
  follows       Follow[] @relation("Follower")
  followers     Follow[] @relation("Following")
  likes         Like[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  @@index([email])
  @@index([nickname])
  @@index([isExpert])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  USER
  EXPERT
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  WITHDRAWN
}

// ==================== 전문가 프로필 ====================

model ExpertProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title          String
  bio            String   @db.Text
  headline       String?

  primaryField   String
  subFields      String[]
  skills         Skill[]

  experiences    Experience[]
  educations     Education[]
  certifications Certification[]

  hourlyRate     Int?
  availability   Json?
  languages      String[]

  totalProjects  Int      @default(0)
  totalReviews   Int      @default(0)
  averageRating  Float    @default(0)
  responseRate   Float    @default(0)
  responseTime   Int?

  isVerified     Boolean  @default(false)
  verifiedAt     DateTime?
  verificationDocs String[]

  slug           String   @unique

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([primaryField])
  @@index([averageRating])
  @@index([isVerified])
}

model Skill {
  id             String        @id @default(cuid())
  name           String        @unique
  category       String
  expertProfiles ExpertProfile[]
  posts          Post[]

  @@index([category])
}

model Experience {
  id              String        @id @default(cuid())
  expertProfileId String
  expertProfile   ExpertProfile @relation(fields: [expertProfileId], references: [id], onDelete: Cascade)

  company         String
  position        String
  description     String?       @db.Text
  startDate       DateTime
  endDate         DateTime?
  isCurrent       Boolean       @default(false)

  createdAt       DateTime      @default(now())

  @@index([expertProfileId])
}

model Education {
  id              String        @id @default(cuid())
  expertProfileId String
  expertProfile   ExpertProfile @relation(fields: [expertProfileId], references: [id], onDelete: Cascade)

  institution     String
  degree          String
  field           String
  startDate       DateTime
  endDate         DateTime?
  isCurrent       Boolean       @default(false)

  createdAt       DateTime      @default(now())

  @@index([expertProfileId])
}

model Certification {
  id              String        @id @default(cuid())
  expertProfileId String
  expertProfile   ExpertProfile @relation(fields: [expertProfileId], references: [id], onDelete: Cascade)

  name            String
  issuer          String
  issueDate       DateTime
  expiryDate      DateTime?
  credentialUrl   String?

  createdAt       DateTime      @default(now())

  @@index([expertProfileId])
}

// ==================== 포트폴리오 ====================

model Portfolio {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title        String
  description  String   @db.Text
  content      String   @db.Text

  category     String
  tags         String[]

  thumbnailUrl String?
  mediaUrls    String[]
  attachments  Json?

  projectUrl   String?
  clientName   String?
  projectDate  DateTime?
  duration     Int?

  visibility   PortfolioVisibility @default(PUBLIC)

  viewCount    Int      @default(0)
  likeCount    Int      @default(0)

  slug         String   @unique

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  publishedAt  DateTime?

  @@index([userId])
  @@index([category])
  @@index([visibility])
}

enum PortfolioVisibility {
  PUBLIC
  PRIVATE
  UNLISTED
}

// ==================== 게시글/커뮤니티 ====================

model Post {
  id              String   @id @default(cuid())
  authorId        String
  author          User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  type            PostType
  title           String
  content         String   @db.Text
  excerpt         String?

  categoryId      String
  category        Category @relation(fields: [categoryId], references: [id])
  tags            String[]
  skills          Skill[]

  thumbnailUrl    String?
  attachments     Json?

  viewCount       Int      @default(0)
  likeCount       Int      @default(0)
  commentCount    Int      @default(0)
  bookmarkCount   Int      @default(0)

  isAnswered      Boolean  @default(false)
  acceptedAnswerId String? @unique
  acceptedAnswer  Comment? @relation("AcceptedAnswer", fields: [acceptedAnswerId], references: [id])
  bountyAmount    Int?

  status          PostStatus @default(PUBLISHED)
  isPinned        Boolean  @default(false)

  slug            String   @unique

  comments        Comment[]
  bookmarks       Bookmark[]
  likes           Like[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  @@index([authorId])
  @@index([categoryId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  parentId    String?
  parent      Category? @relation("CategoryTree", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryTree")
  posts       Post[]

  order       Int      @default(0)

  createdAt   DateTime @default(now())

  @@index([parentId])
}

model Comment {
  id              String   @id @default(cuid())
  postId          String
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId        String
  author          User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  content         String   @db.Text

  parentId        String?
  parent          Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies         Comment[] @relation("CommentReplies")

  likeCount       Int      @default(0)

  acceptedForPost Post?    @relation("AcceptedAnswer")

  isDeleted       Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([postId])
}

enum PostType {
  ARTICLE
  QUESTION
  DISCUSSION
  SHOWCASE
  TUTORIAL
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  DELETED
}

// ==================== 멘토링 ====================

model MentoringSession {
  id            String   @id @default(cuid())

  mentorId      String
  mentor        User     @relation("Mentor", fields: [mentorId], references: [id])
  menteeId      String
  mentee        User     @relation("Mentee", fields: [menteeId], references: [id])

  title         String
  description   String   @db.Text
  type          MentoringType

  scheduledAt   DateTime
  duration      Int
  timezone      String   @default("Asia/Seoul")

  meetingUrl    String?
  meetingId     String?

  status        MentoringStatus @default(REQUESTED)

  price         Int
  transactionId String?  @unique
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  reviewId      String?  @unique
  review        Review?

  mentorNotes   String?  @db.Text
  menteeNotes   String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  completedAt   DateTime?
  cancelledAt   DateTime?

  @@index([mentorId])
  @@index([menteeId])
  @@index([status])
  @@index([scheduledAt])
}

enum MentoringType {
  VIDEO_CALL
  VOICE_CALL
  CHAT
  DOCUMENT_REVIEW
}

enum MentoringStatus {
  REQUESTED
  ACCEPTED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ==================== 채팅 ====================

model ChatRoom {
  id              String   @id @default(cuid())
  type            ChatRoomType
  name            String?

  members         ChatRoomMember[]
  messages        ChatMessage[]

  lastMessageAt   DateTime?
  lastMessagePreview String?

  mentoringSessionId String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
  @@index([lastMessageAt])
}

model ChatRoomMember {
  id          String   @id @default(cuid())
  chatRoomId  String
  chatRoom    ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role        ChatMemberRole @default(MEMBER)

  lastReadAt  DateTime?
  unreadCount Int      @default(0)

  isMuted     Boolean  @default(false)

  joinedAt    DateTime @default(now())
  leftAt      DateTime?

  @@unique([chatRoomId, userId])
  @@index([userId])
}

model ChatMessage {
  id          String   @id @default(cuid())
  chatRoomId  String
  chatRoom    ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  senderId    String

  content     String   @db.Text
  type        ChatMessageType @default(TEXT)

  attachments Json?

  replyToId   String?
  replyTo     ChatMessage? @relation("MessageReplies", fields: [replyToId], references: [id])
  replies     ChatMessage[] @relation("MessageReplies")

  isDeleted   Boolean  @default(false)
  isEdited    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([chatRoomId])
  @@index([senderId])
  @@index([createdAt])
}

model DirectMessage {
  id          String   @id @default(cuid())
  senderId    String
  sender      User     @relation("MessageSender", fields: [senderId], references: [id])
  receiverId  String
  receiver    User     @relation("MessageReceiver", fields: [receiverId], references: [id])

  content     String   @db.Text
  type        ChatMessageType @default(TEXT)
  attachments Json?

  isRead      Boolean  @default(false)
  readAt      DateTime?

  isDeleted   Boolean  @default(false)

  createdAt   DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

enum ChatRoomType {
  DIRECT
  GROUP
  MENTORING
  PROJECT
}

enum ChatMemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum ChatMessageType {
  TEXT
  IMAGE
  FILE
  LINK
  SYSTEM
  VIDEO_CALL_STARTED
  VIDEO_CALL_ENDED
}

// ==================== 결제/정산 ====================

model Transaction {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])

  type             TransactionType
  status           TransactionStatus @default(PENDING)

  amount           Int
  currency         String   @default("KRW")
  fee              Int      @default(0)
  netAmount        Int

  paymentMethod    PaymentMethod?
  paymentGateway   String?
  gatewayTransactionId String?

  mentoringSession MentoringSession?

  escrowId         String?  @unique
  escrow           Escrow?

  description      String?
  metadata         Json?

  settlementId     String?
  settlement       Settlement? @relation(fields: [settlementId], references: [id])

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  completedAt      DateTime?

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model Escrow {
  id              String   @id @default(cuid())
  transactionId   String   @unique
  transaction     Transaction @relation(fields: [transactionId], references: [id])

  buyerId         String
  sellerId        String

  amount          Int
  status          EscrowStatus @default(HOLDING)

  releaseCondition String?
  autoReleaseAt   DateTime?

  releasedAt      DateTime?
  disputeReason   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

model Settlement {
  id            String   @id @default(cuid())
  userId        String

  periodStart   DateTime
  periodEnd     DateTime

  totalAmount   Int
  fee           Int
  tax           Int      @default(0)
  netAmount     Int

  bankName      String
  accountNumber String
  accountHolder String

  status        SettlementStatus @default(PENDING)

  transactions  Transaction[]

  scheduledAt   DateTime
  completedAt   DateTime?

  receiptUrl    String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([scheduledAt])
}

enum TransactionType {
  PAYMENT
  REFUND
  SETTLEMENT
  WITHDRAWAL
  DEPOSIT
  PLATFORM_FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  VIRTUAL_ACCOUNT
  KAKAO_PAY
  NAVER_PAY
  TOSS_PAY
}

enum EscrowStatus {
  HOLDING
  RELEASED
  REFUNDED
  DISPUTED
}

enum SettlementStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ==================== 리뷰 ====================

model Review {
  id                 String   @id @default(cuid())
  authorId           String
  author             User     @relation(fields: [authorId], references: [id])
  targetUserId       String
  targetUser         User     @relation("ReviewTarget", fields: [targetUserId], references: [id])

  mentoringSessionId String?  @unique
  mentoringSession   MentoringSession? @relation(fields: [mentoringSessionId], references: [id])

  overallRating      Float
  communicationRating Float?
  expertiseRating    Float?
  punctualityRating  Float?

  content            String   @db.Text

  tags               String[]

  isPublic           Boolean  @default(true)

  replyContent       String?  @db.Text
  repliedAt          DateTime?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([authorId])
  @@index([targetUserId])
  @@index([overallRating])
}

// ==================== 팔로우/북마크 ====================

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  follower    User     @relation("Follower", fields: [followerId], references: [id])
  followingId String
  following   User     @relation("Following", fields: [followingId], references: [id])

  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId    String?
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)

  folder    String?

  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([userId])
}

// ==================== 알림 ====================

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        NotificationType
  title       String
  content     String

  relatedType String?
  relatedId   String?

  actionUrl   String?

  isRead      Boolean  @default(false)
  readAt      DateTime?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  NEW_FOLLOWER
  NEW_COMMENT
  COMMENT_REPLY
  POST_LIKE
  MENTORING_REQUEST
  MENTORING_ACCEPTED
  MENTORING_REJECTED
  MENTORING_REMINDER
  MENTORING_COMPLETED
  PAYMENT_COMPLETED
  PAYMENT_FAILED
  SETTLEMENT_COMPLETED
  NEW_REVIEW
  REVIEW_REPLY
  NEW_MESSAGE
  SYSTEM_NOTICE
  ACCOUNT_VERIFIED
}
